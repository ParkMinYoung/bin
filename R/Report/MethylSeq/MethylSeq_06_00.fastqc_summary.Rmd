---
output: pdf_document
---


# **Data Quality Control**


Modern high throughput sequencers can generate hundreds of millions of sequences in a single run. Before analysing this sequence to draw biological conclusions you should always perform some simple quality control checks to ensure that the raw data looks good and there are no problems or biases in your data which may affect how you can usefully use it.  

Most sequencers will generate a QC report as part of their analysis pipeline, but this is usually only focused on identifying problems which were generated by the sequencer itself. FastQC aims to provide a QC report which can spot problems which originate either in the sequencer or in the starting library material.  


```{r}

fastqc_stat<-
  mutate(fastqc_stat, tot.seq = comma(as.numeric(tot.seq) ) )


```


```{r, results='asis', eval=(knitr::opts_knit$get('rmarkdown.pandoc.to') == 'latex')}
# usepackage_latex("threeparttable")

fastqc_footnote <-fastqc_stat

# for( i in 2:length(names(fastqc_footnote)) ) {
# 
#   names(fastqc_footnote)[i] <- paste0(names(fastqc_footnote)[i], footnote_marker_alphabet(i-1, "latex"))
# }

# kable(fastqc_stat, format = "latex", longtable = T, booktabs = T, caption = "QC Summary") %>%
#   kable_styling(latex_options = c("striped", "scale_down")) %>% 
#   kable_styling( font_size = 11, full_width = F) 

kable(fastqc_footnote, format = "latex", longtable =T, booktabs = T, caption = "QC Summary") %>%
  kable_styling( latex_options = c("striped", "hold_position"),  
#                 font_size = 10, 
                 full_width = F ) %>%
  footnote(
           #general = "Column Description of table",
           alphabet = c(
             "tot.seq : total sequences",
             "pct.length : sequence length",
             "pct.gc : percentage of GC content",
             "pct.dup : percentage of duplicate reads"
           )
)


```


```{r, results='asis', eval=(knitr::opts_knit$get('rmarkdown.pandoc.to') != 'latex')}

filename_dt="fastqc_stat"
datatable(fastqc_stat, filter = "bottom",
          extensions = c('Scroller', 'Buttons'),
          options = list(pageLength = 10,
                         deferRender = TRUE,
                         scrollX = TRUE,
                         scrollY = 200,
                         scroller = TRUE,
                         dom = 'Bfrtip',
                         buttons = list('copy',
                                        list(extend='excel',filename=filename_dt),
                                        list(extend='csv',filename=filename_dt)),
                         columnDefs = list(list(width = '1000px', targets = "_all", className = 'dt-center')
                         )
          )
)

```


 <!-- * module: fastqc modules -->
 <!-- * status: fastqc module status for each sample -->
 
```{r, results='asis', eval=(knitr::opts_knit$get('rmarkdown.pandoc.to') != 'latex')}

cat("Column names:<br><br>")
cat(" * sample: sample names")
cat(" * tot.seq: total sequences (i.e.: the number of reads)")
cat(" * seq.length: sequence length")
cat(" * pct.gc: percentage of GC content")
cat(" * pct.dup: percentage of duplicate reads")

```

\clearpage

```{r}
fastqc_zip<-
  list.files(path = "FastqcZip", pattern = "fastqc.zip$", recursive = TRUE, full.names = TRUE)

modules<-
c(
#  "Per sequence GC content",
  "Per base sequence quality", 
  "Per sequence quality scores", 
  "Per base sequence content"
  #"Sequence duplication levels"
  )

mainDir="./"
subDir="figure.png"
dir.create(file.path(mainDir, subDir), showWarnings = FALSE)


```



```{r dataQC, results='asis', echo=FALSE, comment="", fig.width=7}


make_fastqc_file <- function(filename){
  
  require(gridExtra)
  if(!file.exists(filename)){ 
     ###  print( title )
     qc <- qc_read(i)

     ### to save time ###
     plotList<-list()
     file_c<-0
     num<-0
  
     file_c<-file_c+1
     
     for (m in modules) {
         num <- num + 1
         ###print(num)
         plotList[[num]] <- qc_plot(qc, m)
     }
     png(filename , height = 300, width = 900)
     do.call(grid.arrange, c(plotList, list(ncol=length(modules) )) )
     dev.off()
  }
  
}

filenum<-0

for ( i in fastqc_zip) {


  # i=fastqc_zip[1]  
  # title = gsub("^FastqcZip/(.+)_\\w{6,8}_L\\d+_(R\\d).+", "### \\1 \\2", i, perl=TRUE)
  title = gsub("^FastqcZip/(.+)_\\w{6,8}_L\\d+_(R\\d).+", "\\1 \\2", i, perl=TRUE)
  
  # filename<- gsub("### (.+) (.+)", "\\1-\\2.png", title)
  filename<- gsub("(.+) (.+)", "\\1-\\2.png", title)
  filename<-paste(subDir, filename, sep="/")

  make_fastqc_file(filename)

  if( knitr::opts_knit$get('rmarkdown.pandoc.to') == 'latex' ){
      
      cat("\n \n ")
      # cat(title)
      cat("\n \n ")
      cat("![",title,"](",filename,")", sep="")
      cat("\n \n ")
      
      filenum<- filenum + 1
      string<-ifelse(filenum%%2==0, "\n \n \\ \\pagebreak", "\n")
      cat(string)
      

  }else{
      cat("<br>\n<br>\n<br>\n<br>\n<br>\n")
      cat("\n")
      cat(title)
      cat("\n")

      cat("![",title,"](",filename,")", sep="")

      cat("\n")
      # cat("<br>\n<br>\n<br>\n<br>\n<br>\n")

  }
    
  
  
  
}


```


